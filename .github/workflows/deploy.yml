name: Deploy ComplianceOS to Alibaba Cloud ECS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Build Docker image on GitHub Actions 
      - name: Build Docker Image Locally
        run: |
          docker build -t compliance-os-v2:latest .
          # Compress the tar file to drastically reduce SCP transfer time and network usage
          docker save compliance-os-v2:latest | gzip > compliance-os-v2.tar.gz

      # Upload via SCP
      - name: Copy Compressed Docker Image to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_ECS_HOST }}
          username: ${{ secrets.ALIYUN_ECS_USER }}
          key: ${{ secrets.ALIYUN_ECS_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "compliance-os-v2.tar.gz,docker-compose.yml"
          target: "/opt/compliance-os-v2"
          overwrite: true

      - name: Deploy to Alibaba Cloud ECS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ALIYUN_ECS_HOST }}
          username: ${{ secrets.ALIYUN_ECS_USER }}
          key: ${{ secrets.ALIYUN_ECS_SSH_KEY }}
          command_timeout: 15m
          script: |
            set -e
            export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"
            
            cd /opt/compliance-os-v2
            
            # Load the compressed image
            echo "Loading new compressed Docker image..."
            # docker load supports reading directly from gzip
            docker load -i compliance-os-v2.tar.gz
            rm compliance-os-v2.tar.gz
            
            # Write secrets
            echo "ZHIPU_API_KEY=${{ secrets.ZHIPU_API_KEY }}" > .env
            
            mkdir -p data
            chmod 777 data
            
            # Restart container using the loaded image
            echo "Starting container..."
            if docker compose version >/dev/null 2>&1; then
              docker compose up -d
            else
              docker-compose up -d
            fi
            
            docker image prune -f
