name: Deploy ComplianceOS to Alibaba Cloud ECS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # We can't build efficiently on the 2GB server. 
      # Solution: Build the Docker image ON GITHUB ACTIONS (which has 7GB RAM and fast CPU)
      # Then save it to a tar archive, scp it to the server, and load it.
      # This completely bypasses the server memory limitations!
      
      - name: Build Docker Image Locally
        run: |
          docker build -t compliance-os-v2:latest .
          docker save compliance-os-v2:latest -o compliance-os-v2.tar
          # Fix permission issue where scp-action (running inside its own container) cannot read the tar file created by docker
          chmod 644 compliance-os-v2.tar

      - name: Copy Docker Image to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALIYUN_ECS_HOST }}
          username: ${{ secrets.ALIYUN_ECS_USER }}
          key: ${{ secrets.ALIYUN_ECS_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "compliance-os-v2.tar,docker-compose.yml"
          target: "/opt/compliance-os-v2"
          overwrite: true

      - name: Deploy to Alibaba Cloud ECS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ALIYUN_ECS_HOST }}
          username: ${{ secrets.ALIYUN_ECS_USER }}
          key: ${{ secrets.ALIYUN_ECS_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e
            export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"
            
            cd /opt/compliance-os-v2
            
            # Load the image built by GitHub Actions
            echo "Loading new Docker image..."
            docker load -i compliance-os-v2.tar
            rm compliance-os-v2.tar
            
            # Write secrets
            echo "ZHIPU_API_KEY=${{ secrets.ZHIPU_API_KEY }}" > .env
            
            mkdir -p data
            chmod 777 data
            
            # Restart container using the loaded image (no --build needed!)
            echo "Starting container..."
            if docker compose version >/dev/null 2>&1; then
              docker compose up -d
            else
              docker-compose up -d
            fi
            
            docker image prune -f
